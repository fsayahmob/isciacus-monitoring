name: Deploy Dev (Fast)

# =====================================================
# Fast deployment workflow for testing
# Skips E2E tests - use for quick iterations
# Triggered manually via GitHub Actions UI
# =====================================================

on:
  workflow_dispatch:
    inputs:
      skip_lint:
        description: 'Skip lint checks'
        required: false
        default: 'false'
        type: boolean

env:
  NODE_VERSION: '20'
  PYTHON_VERSION: '3.11'

jobs:
  # =====================================================
  # JOB 1: Quick Quality Check (optional)
  # =====================================================
  quality-check:
    name: Quick Quality Check
    runs-on: ubuntu-latest
    if: ${{ inputs.skip_lint != true }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install frontend dependencies
        run: cd frontend && npm ci

      - name: Frontend lint & typecheck
        run: |
          cd frontend
          npm run lint
          npm run typecheck

      - name: Install backend dependencies
        run: |
          cd backend
          pip install ruff mypy

      - name: Backend lint
        run: cd backend && ruff check .

  # =====================================================
  # JOB 2: Deploy to Dev Environment
  # =====================================================
  deploy-dev:
    name: Deploy to Dev
    runs-on: ubuntu-latest
    needs: [quality-check]
    if: always() && (needs.quality-check.result == 'success' || needs.quality-check.result == 'skipped')
    environment: dev
    env:
      PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
      REGION: europe-west1
      ENV_SUFFIX: -dev

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check GCP secrets
        id: check-secrets
        run: |
          if [ -z "${{ secrets.GCP_PROJECT_ID }}" ] || [ -z "${{ secrets.GCP_SA_KEY }}" ]; then
            echo "configured=false" >> $GITHUB_OUTPUT
            echo "⚠️ GCP secrets not configured. Skipping deployment."
            echo "To enable deployment, add these secrets:"
            echo "  - GCP_PROJECT_ID"
            echo "  - GCP_SA_KEY"
          else
            echo "configured=true" >> $GITHUB_OUTPUT
          fi

      - name: Authenticate to Google Cloud
        if: steps.check-secrets.outputs.configured == 'true'
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Setup gcloud CLI
        if: steps.check-secrets.outputs.configured == 'true'
        uses: google-github-actions/setup-gcloud@v2

      - name: Create Artifact Registry (if not exists)
        if: steps.check-secrets.outputs.configured == 'true'
        run: |
          gcloud artifacts repositories describe isciacus-monitoring \
            --location=${{ env.REGION }} 2>/dev/null || \
          gcloud artifacts repositories create isciacus-monitoring \
            --repository-format=docker \
            --location=${{ env.REGION }} \
            --description="ISCIACUS Monitoring Docker images"

      - name: Configure Docker for Artifact Registry
        if: steps.check-secrets.outputs.configured == 'true'
        run: gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev --quiet

      - name: Set image tag
        id: meta
        run: echo "sha=${GITHUB_SHA::8}" >> $GITHUB_OUTPUT

      - name: Build and push Backend image
        if: steps.check-secrets.outputs.configured == 'true'
        run: |
          IMAGE="${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/isciacus-monitoring/backend"
          docker build -t ${IMAGE}:${{ steps.meta.outputs.sha }}-dev -t ${IMAGE}:dev ./backend
          docker push ${IMAGE}:${{ steps.meta.outputs.sha }}-dev
          docker push ${IMAGE}:dev

      - name: Create GCS bucket for dev data
        if: steps.check-secrets.outputs.configured == 'true'
        run: |
          BUCKET_NAME="${{ env.PROJECT_ID }}-isciacus-data-dev"
          gcloud storage buckets describe "gs://${BUCKET_NAME}" 2>/dev/null || \
          gcloud storage buckets create "gs://${BUCKET_NAME}" \
            --location=${{ env.REGION }} \
            --uniform-bucket-level-access

      - name: Pull and push PocketBase image to Artifact Registry
        if: steps.check-secrets.outputs.configured == 'true'
        run: |
          docker pull ghcr.io/muchobien/pocketbase:latest
          IMAGE="${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/isciacus-monitoring/pocketbase"
          docker tag ghcr.io/muchobien/pocketbase:latest ${IMAGE}:latest
          docker tag ghcr.io/muchobien/pocketbase:latest ${IMAGE}:dev
          docker push ${IMAGE}:latest
          docker push ${IMAGE}:dev

      - name: Deploy PocketBase (Dev)
        if: steps.check-secrets.outputs.configured == 'true'
        id: deploy-pocketbase
        run: |
          BUCKET_NAME="${{ env.PROJECT_ID }}-isciacus-data-dev"
          IMAGE="${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/isciacus-monitoring/pocketbase"
          gcloud run deploy isciacus-pocketbase${{ env.ENV_SUFFIX }} \
            --image=${IMAGE}:dev \
            --region=${{ env.REGION }} \
            --platform=managed \
            --allow-unauthenticated \
            --port=8090 \
            --memory=512Mi \
            --cpu=1 \
            --min-instances=0 \
            --max-instances=2 \
            --set-env-vars="PB_ADMIN_EMAIL=admin@isciacus.com,PB_ADMIN_PASSWORD=devpass123" \
            --add-volume=name=pocketbase-data,type=cloud-storage,bucket=${BUCKET_NAME},mount-options="only-dir=pocketbase" \
            --add-volume-mount=volume=pocketbase-data,mount-path=/pb_data \
            --execution-environment=gen2 \
            --quiet
          URL=$(gcloud run services describe isciacus-pocketbase${{ env.ENV_SUFFIX }} --region=${{ env.REGION }} --format='value(status.url)')
          echo "url=${URL}" >> $GITHUB_OUTPUT

      - name: Deploy Backend (Dev)
        if: steps.check-secrets.outputs.configured == 'true'
        id: deploy-backend
        run: |
          IMAGE="${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/isciacus-monitoring/backend"
          BUCKET_NAME="${{ env.PROJECT_ID }}-isciacus-data-dev"
          gcloud run deploy isciacus-backend${{ env.ENV_SUFFIX }} \
            --image=${IMAGE}:${{ steps.meta.outputs.sha }}-dev \
            --region=${{ env.REGION }} \
            --platform=managed \
            --allow-unauthenticated \
            --port=8080 \
            --memory=1Gi \
            --cpu=2 \
            --min-instances=0 \
            --max-instances=5 \
            --timeout=300 \
            --set-env-vars="POCKETBASE_URL=${{ steps.deploy-pocketbase.outputs.url }},DATA_DIR=/app/data,ENVIRONMENT=dev" \
            --add-volume=name=backend-data,type=cloud-storage,bucket=${BUCKET_NAME},mount-options="only-dir=backend" \
            --add-volume-mount=volume=backend-data,mount-path=/app/data \
            --execution-environment=gen2 \
            --quiet
          URL=$(gcloud run services describe isciacus-backend${{ env.ENV_SUFFIX }} --region=${{ env.REGION }} --format='value(status.url)')
          echo "url=${URL}" >> $GITHUB_OUTPUT

      - name: Build and push Frontend image with API URLs
        if: steps.check-secrets.outputs.configured == 'true'
        run: |
          IMAGE="${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/isciacus-monitoring/frontend"
          docker build \
            --build-arg VITE_API_BASE_URL=${{ steps.deploy-backend.outputs.url }} \
            --build-arg VITE_POCKETBASE_URL=${{ steps.deploy-pocketbase.outputs.url }} \
            --build-arg VITE_ENVIRONMENT=dev \
            --build-arg VITE_APP_VERSION=${{ steps.meta.outputs.sha }} \
            --build-arg VITE_GCP_PROJECT_ID=${{ secrets.GCP_PROJECT_ID }} \
            --build-arg VITE_GCP_API_KEY=${{ secrets.VITE_GCP_API_KEY }} \
            -t ${IMAGE}:${{ steps.meta.outputs.sha }}-dev \
            -t ${IMAGE}:dev \
            --target production \
            ./frontend
          docker push ${IMAGE}:${{ steps.meta.outputs.sha }}-dev
          docker push ${IMAGE}:dev

      - name: Deploy Frontend (Dev)
        if: steps.check-secrets.outputs.configured == 'true'
        id: deploy-frontend
        run: |
          IMAGE="${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/isciacus-monitoring/frontend"
          gcloud run deploy isciacus-frontend${{ env.ENV_SUFFIX }} \
            --image=${IMAGE}:${{ steps.meta.outputs.sha }}-dev \
            --region=${{ env.REGION }} \
            --platform=managed \
            --allow-unauthenticated \
            --port=80 \
            --memory=256Mi \
            --cpu=1 \
            --min-instances=0 \
            --max-instances=5 \
            --quiet
          URL=$(gcloud run services describe isciacus-frontend${{ env.ENV_SUFFIX }} --region=${{ env.REGION }} --format='value(status.url)')
          echo "url=${URL}" >> $GITHUB_OUTPUT

      - name: Initialize PocketBase collections (Dev)
        if: steps.check-secrets.outputs.configured == 'true'
        run: |
          echo "Waiting for PocketBase..."
          for i in {1..30}; do
            if curl -sf "${{ steps.deploy-pocketbase.outputs.url }}/api/health" > /dev/null 2>&1; then
              echo "PocketBase is ready!"
              break
            fi
            echo "Attempt $i/30..."
            sleep 5
          done
          cd backend && pip install requests && python scripts/init_pocketbase.py
        env:
          POCKETBASE_URL: ${{ steps.deploy-pocketbase.outputs.url }}
          PB_ADMIN_EMAIL: admin@isciacus.com
          PB_ADMIN_PASSWORD: devpass123

      - name: Dev Deployment Summary
        if: steps.check-secrets.outputs.configured == 'true'
        run: |
          echo "## Dev Deployment Complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### URLs (Dev)" >> $GITHUB_STEP_SUMMARY
          echo "- **Frontend**: ${{ steps.deploy-frontend.outputs.url }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Backend**: ${{ steps.deploy-backend.outputs.url }}" >> $GITHUB_STEP_SUMMARY
          echo "- **PocketBase**: ${{ steps.deploy-pocketbase.outputs.url }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Image Tag: \`${{ steps.meta.outputs.sha }}-dev\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Note**: This is a dev environment deployed without E2E tests." >> $GITHUB_STEP_SUMMARY
