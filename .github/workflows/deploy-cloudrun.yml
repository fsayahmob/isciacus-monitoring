# =============================================================================
# GitHub Actions - Deploy to Google Cloud Run
# =============================================================================
# Deploys ISCIACUS Monitoring to Cloud Run with GCS persistent storage
# Triggered on push to main branch after successful tests
#
# SECRETS REQUIS (uniquement GCP - 2 secrets):
#   - GCP_PROJECT_ID : ID du projet Google Cloud
#   - GCP_SA_KEY     : JSON de la clÃ© du service account
#
# PERSISTANCE:
#   - GCS Bucket: ${PROJECT_ID}-isciacus-data
#   - Backend: /app/data (SQLite secrets) â†’ gs://bucket/backend/
#   - PocketBase: /pb_data (sessions) â†’ gs://bucket/pocketbase/
#
# Les secrets mÃ©tier (Shopify, GA4, etc.) sont stockÃ©s dans la base SQLite
# du backend et configurables via la page Settings du dashboard.
# =============================================================================

name: Deploy to Cloud Run

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

env:
  PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
  REGION: europe-west1

jobs:
  # ===========================================================================
  # Job 1: Build and Push Docker Images
  # ===========================================================================
  build-images:
    name: ðŸ³ Build Docker Images
    runs-on: ubuntu-latest
    outputs:
      image_tag: ${{ steps.meta.outputs.sha }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set image tag
        id: meta
        run: echo "sha=${GITHUB_SHA::8}" >> $GITHUB_OUTPUT

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Setup gcloud CLI
        uses: google-github-actions/setup-gcloud@v2

      - name: Create Artifact Registry (if not exists)
        run: |
          gcloud services enable artifactregistry.googleapis.com --quiet
          gcloud artifacts repositories describe isciacus-monitoring \
            --location=${{ env.REGION }} 2>/dev/null || \
          gcloud artifacts repositories create isciacus-monitoring \
            --repository-format=docker \
            --location=${{ env.REGION }} \
            --description="ISCIACUS Monitoring Docker images"

      - name: Configure Docker for Artifact Registry
        run: gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev --quiet

      - name: Build and push Backend image
        run: |
          IMAGE="${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/isciacus-monitoring/backend"
          docker build -t ${IMAGE}:${{ steps.meta.outputs.sha }} -t ${IMAGE}:latest ./backend
          docker push ${IMAGE}:${{ steps.meta.outputs.sha }}
          docker push ${IMAGE}:latest

      - name: Build and push Frontend image
        run: |
          IMAGE="${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/isciacus-monitoring/frontend"
          docker build -t ${IMAGE}:${{ steps.meta.outputs.sha }} -t ${IMAGE}:latest --target production ./frontend
          docker push ${IMAGE}:${{ steps.meta.outputs.sha }}
          docker push ${IMAGE}:latest

  # ===========================================================================
  # Job 2: Deploy with gcloud (simplified, no Terraform state needed)
  # ===========================================================================
  deploy:
    name: ðŸš€ Deploy to Cloud Run
    runs-on: ubuntu-latest
    needs: [build-images]
    environment: production
    outputs:
      frontend_url: ${{ steps.deploy-frontend.outputs.url }}
      backend_url: ${{ steps.deploy-backend.outputs.url }}
      pocketbase_url: ${{ steps.deploy-pocketbase.outputs.url }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Setup gcloud CLI
        uses: google-github-actions/setup-gcloud@v2

      - name: Enable required APIs
        run: gcloud services enable run.googleapis.com artifactregistry.googleapis.com storage.googleapis.com

      - name: Create GCS bucket for persistent data (if not exists)
        run: |
          BUCKET_NAME="${{ env.PROJECT_ID }}-isciacus-data"
          if ! gcloud storage buckets describe "gs://${BUCKET_NAME}" 2>/dev/null; then
            echo "Creating bucket ${BUCKET_NAME}..."
            gcloud storage buckets create "gs://${BUCKET_NAME}" \
              --location=${{ env.REGION }} \
              --uniform-bucket-level-access
            echo "âœ… Bucket created"
          else
            echo "âœ… Bucket already exists"
          fi

      - name: Create Artifact Registry (if not exists)
        run: |
          gcloud artifacts repositories describe isciacus-monitoring \
            --location=${{ env.REGION }} 2>/dev/null || \
          gcloud artifacts repositories create isciacus-monitoring \
            --repository-format=docker \
            --location=${{ env.REGION }} \
            --description="ISCIACUS Monitoring Docker images"

      - name: Deploy PocketBase
        id: deploy-pocketbase
        run: |
          BUCKET_NAME="${{ env.PROJECT_ID }}-isciacus-data"

          # Deploy with GCS volume for persistent data
          gcloud run deploy isciacus-pocketbase \
            --image=ghcr.io/muchobien/pocketbase:latest \
            --region=${{ env.REGION }} \
            --platform=managed \
            --allow-unauthenticated \
            --port=8090 \
            --memory=512Mi \
            --cpu=1 \
            --min-instances=1 \
            --max-instances=2 \
            --set-env-vars="PB_ADMIN_EMAIL=admin@isciacus.com,PB_ADMIN_PASSWORD=prodpass123" \
            --add-volume=name=pocketbase-data,type=cloud-storage,bucket=${BUCKET_NAME},mount-options="only-dir=pocketbase" \
            --add-volume-mount=volume=pocketbase-data,mount-path=/pb_data \
            --execution-environment=gen2 \
            --quiet

          URL=$(gcloud run services describe isciacus-pocketbase --region=${{ env.REGION }} --format='value(status.url)')
          echo "url=${URL}" >> $GITHUB_OUTPUT

      - name: Deploy Backend
        id: deploy-backend
        run: |
          IMAGE="${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/isciacus-monitoring/backend"
          BUCKET_NAME="${{ env.PROJECT_ID }}-isciacus-data"

          # Deploy with GCS volume for SQLite persistent data
          gcloud run deploy isciacus-backend \
            --image=${IMAGE}:${{ needs.build-images.outputs.image_tag }} \
            --region=${{ env.REGION }} \
            --platform=managed \
            --allow-unauthenticated \
            --port=8080 \
            --memory=1Gi \
            --cpu=2 \
            --min-instances=0 \
            --max-instances=10 \
            --timeout=300 \
            --set-env-vars="POCKETBASE_URL=${{ steps.deploy-pocketbase.outputs.url }},DATA_DIR=/app/data" \
            --add-volume=name=backend-data,type=cloud-storage,bucket=${BUCKET_NAME},mount-options="only-dir=backend" \
            --add-volume-mount=volume=backend-data,mount-path=/app/data \
            --execution-environment=gen2 \
            --quiet

          URL=$(gcloud run services describe isciacus-backend --region=${{ env.REGION }} --format='value(status.url)')
          echo "url=${URL}" >> $GITHUB_OUTPUT

      - name: Deploy Frontend
        id: deploy-frontend
        run: |
          IMAGE="${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/isciacus-monitoring/frontend"

          gcloud run deploy isciacus-frontend \
            --image=${IMAGE}:${{ needs.build-images.outputs.image_tag }} \
            --region=${{ env.REGION }} \
            --platform=managed \
            --allow-unauthenticated \
            --port=80 \
            --memory=256Mi \
            --cpu=1 \
            --min-instances=0 \
            --max-instances=10 \
            --set-env-vars="VITE_API_BASE_URL=${{ steps.deploy-backend.outputs.url }},VITE_POCKETBASE_URL=${{ steps.deploy-pocketbase.outputs.url }}" \
            --quiet

          URL=$(gcloud run services describe isciacus-frontend --region=${{ env.REGION }} --format='value(status.url)')
          echo "url=${URL}" >> $GITHUB_OUTPUT

      - name: Deployment Summary
        run: |
          BUCKET_NAME="${{ env.PROJECT_ID }}-isciacus-data"
          echo "## ðŸš€ Deployment Complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### URLs" >> $GITHUB_STEP_SUMMARY
          echo "- **Frontend**: ${{ steps.deploy-frontend.outputs.url }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Backend**: ${{ steps.deploy-backend.outputs.url }}" >> $GITHUB_STEP_SUMMARY
          echo "- **PocketBase**: ${{ steps.deploy-pocketbase.outputs.url }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Image Tag" >> $GITHUB_STEP_SUMMARY
          echo "\`${{ needs.build-images.outputs.image_tag }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Persistance" >> $GITHUB_STEP_SUMMARY
          echo "- **GCS Bucket**: \`${BUCKET_NAME}\`" >> $GITHUB_STEP_SUMMARY
          echo "- SQLite (secrets) et PocketBase (sessions) sont persistÃ©s via Cloud Storage volumes." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Configuration" >> $GITHUB_STEP_SUMMARY
          echo "Les secrets mÃ©tier (Shopify, GA4, etc.) sont configurables via la page **Settings** du dashboard." >> $GITHUB_STEP_SUMMARY

  # ===========================================================================
  # Job 3: Initialize PocketBase Collections
  # ===========================================================================
  init-pocketbase:
    name: ðŸ—ƒï¸ Initialize PocketBase
    runs-on: ubuntu-latest
    needs: [deploy]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install requests

      - name: Wait for PocketBase to be ready
        run: |
          echo "Waiting for PocketBase to be ready..."
          for i in {1..30}; do
            if curl -sf "${{ needs.deploy.outputs.pocketbase_url }}/api/health" > /dev/null 2>&1; then
              echo "âœ… PocketBase is ready!"
              exit 0
            fi
            echo "Attempt $i/30..."
            sleep 5
          done
          echo "âŒ PocketBase did not become ready in time"
          exit 1

      - name: Initialize collections
        working-directory: backend
        env:
          POCKETBASE_URL: ${{ needs.deploy.outputs.pocketbase_url }}
          PB_ADMIN_EMAIL: admin@isciacus.com
          PB_ADMIN_PASSWORD: prodpass123
        run: python scripts/init_pocketbase.py

  # ===========================================================================
  # Job 4: Smoke Tests
  # ===========================================================================
  smoke-tests:
    name: ðŸ§ª Smoke Tests
    runs-on: ubuntu-latest
    needs: [deploy, init-pocketbase]

    steps:
      - name: Test Frontend
        run: |
          echo "Testing frontend..."
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "${{ needs.deploy.outputs.frontend_url }}")
          if [ "$HTTP_CODE" = "200" ]; then
            echo "âœ… Frontend is responding (HTTP $HTTP_CODE)"
          else
            echo "âŒ Frontend returned HTTP $HTTP_CODE"
            exit 1
          fi

      - name: Test Backend Health
        run: |
          echo "Testing backend health endpoint..."
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "${{ needs.deploy.outputs.backend_url }}/health")
          if [ "$HTTP_CODE" = "200" ]; then
            echo "âœ… Backend health check passed (HTTP $HTTP_CODE)"
          else
            echo "âŒ Backend health check failed (HTTP $HTTP_CODE)"
            exit 1
          fi

      - name: Test PocketBase
        run: |
          echo "Testing PocketBase..."
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" "${{ needs.deploy.outputs.pocketbase_url }}/api/health")
          if [ "$HTTP_CODE" = "200" ]; then
            echo "âœ… PocketBase is healthy (HTTP $HTTP_CODE)"
          else
            echo "âŒ PocketBase health check failed (HTTP $HTTP_CODE)"
            exit 1
          fi

      - name: Summary
        run: |
          echo "## ðŸ§ª Smoke Tests Passed!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All services are responding correctly." >> $GITHUB_STEP_SUMMARY
