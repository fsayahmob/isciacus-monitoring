name: Code Quality & CI/CD

# =====================================================
# ISCIACUS Monitoring - Monorepo CI/CD Pipeline
# =====================================================
# FAANG-level strict configuration inspired by SellGlow iOS
#
# Philosophy: Architecture-Driven Development (ADD)
# - All lint rules are ERROR level (not warning)
# - Zero tolerance for code quality violations
# - Guards prevent rule weakening
# - Coverage enforcement (70% minimum)
#
# Jobs:
# 1. config-guard     - Protects lint configs from weakening
# 2. frontend-quality - ESLint + TypeScript
# 3. backend-quality  - Ruff + Black + MyPy
# 4. frontend-tests   - Vitest with coverage
# 5. backend-tests    - Pytest with coverage
# 6. build            - Production builds
# 7. deploy           - Deployment (main branch only)
# =====================================================

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

env:
  NODE_VERSION: '20'
  PYTHON_VERSION: '3.11'
  COVERAGE_THRESHOLD: 70

jobs:
  # =====================================================
  # JOB 1: Configuration Guard (SellGlow-style)
  # =====================================================
  # Prevents weakening of lint rules for BOTH frontend and backend
  # =====================================================
  config-guard:
    name: ğŸ›¡ï¸ Configuration Guard
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ” META-GUARD - Detect workflow modifications
        run: |
          echo "=== META-GUARD: Detecting workflow modifications ==="

          if git diff origin/main...HEAD --name-only 2>/dev/null | grep -q ".github/workflows/"; then
            echo "âš ï¸  ATTENTION: Workflow files modified!"
            echo "This change requires explicit approval from CODEOWNERS"
            echo ""
            echo "Modified files:"
            git diff origin/main...HEAD --name-only | grep ".github/workflows/" || true
          else
            echo "âœ… Workflow files unchanged"
          fi

      # =====================================================
      # FRONTEND GUARDS (ESLint)
      # =====================================================
      - name: ğŸ” [FRONTEND] Guard 1 - No warning severity
        run: |
          echo "=== FRONTEND GUARD 1: All ESLint rules must be ERROR ==="

          # Check for 'warn' as a rule severity (not inside allow arrays)
          # Pattern: : 'warn' or : "warn" or ['warn', or ["warn",
          if grep -E ":\s*'warn'|:\s*\"warn\"|\\['warn',|\\[\"warn\"," frontend/eslint.config.js 2>/dev/null; then
            echo "âŒ BLOCKED: Found 'warn' severity in ESLint config!"
            echo ""
            echo "ğŸš¨ VIOLATION TYPE: Frontend Rule Weakening"
            exit 1
          fi

          echo "âœ… All frontend rules are error severity"

      - name: ğŸ” [FRONTEND] Guard 2 - Max 3 disabled rules
        run: |
          echo "=== FRONTEND GUARD 2: Maximum 3 disabled ESLint rules ==="

          OFF_COUNT=$(grep -cE "'off'|\"off\"" frontend/eslint.config.js 2>/dev/null || echo "0")
          echo "Found $OFF_COUNT disabled rules"

          if [ "$OFF_COUNT" -gt 3 ]; then
            echo "âŒ BLOCKED: Too many disabled rules ($OFF_COUNT > 3)"
            echo ""
            echo "ğŸš¨ VIOLATION TYPE: Excessive Rule Disabling"
            exit 1
          fi

          echo "âœ… Disabled rules count acceptable ($OFF_COUNT â‰¤ 3)"

      - name: ğŸ” [FRONTEND] Guard 3 - No eslint-disable in code
        run: |
          echo "=== FRONTEND GUARD 3: No inline eslint-disable ==="

          if grep -rn "eslint-disable" frontend/src/ 2>/dev/null | grep -v "eslint-disable-next-line @typescript-eslint/no-unused-vars"; then
            echo "âŒ BLOCKED: Found eslint-disable comments!"
            echo ""
            echo "ğŸš¨ VIOLATION TYPE: Inline Rule Bypass"
            exit 1
          fi

          echo "âœ… No forbidden eslint-disable comments"

      - name: ğŸ” [FRONTEND] Guard 4 - Minimum 30 rules
        run: |
          echo "=== FRONTEND GUARD 4: Minimum 30 active rules ==="

          RULE_COUNT=$(grep -cE ":\s*'error'|:\s*\[.*'error'" frontend/eslint.config.js 2>/dev/null || echo "0")
          echo "Found $RULE_COUNT rules with error severity"

          if [ "$RULE_COUNT" -lt 30 ]; then
            echo "âŒ BLOCKED: Not enough rules ($RULE_COUNT < 30)"
            echo ""
            echo "ğŸš¨ VIOLATION TYPE: Rule Count Reduction"
            exit 1
          fi

          echo "âœ… Rule count sufficient ($RULE_COUNT â‰¥ 30)"

      - name: ğŸ” [FRONTEND] Guard 5 - TypeScript strict mode
        run: |
          echo "=== FRONTEND GUARD 5: TypeScript strict mode ==="

          if ! grep -q '"strict": true' frontend/tsconfig.json 2>/dev/null; then
            echo "âŒ BLOCKED: TypeScript strict mode not enabled!"
            echo ""
            echo "ğŸš¨ VIOLATION TYPE: Type Safety Weakening"
            exit 1
          fi

          echo "âœ… TypeScript strict mode enabled"

      # =====================================================
      # BACKEND GUARDS (Ruff/Python)
      # =====================================================
      - name: ğŸ” [BACKEND] Guard 1 - Max 5 ignored Ruff rules
        run: |
          echo "=== BACKEND GUARD 1: Maximum 5 ignored Ruff rules ==="

          # Count rules in ignore list
          IGNORE_COUNT=$(grep -A 20 "^ignore = \[" backend/pyproject.toml 2>/dev/null | grep -c '"[A-Z]' || echo "0")
          echo "Found $IGNORE_COUNT ignored rules"

          if [ "$IGNORE_COUNT" -gt 5 ]; then
            echo "âŒ BLOCKED: Too many ignored Ruff rules ($IGNORE_COUNT > 5)"
            echo ""
            echo "ğŸš¨ VIOLATION TYPE: Python Rule Weakening"
            exit 1
          fi

          echo "âœ… Ignored rules count acceptable ($IGNORE_COUNT â‰¤ 5)"

      - name: ğŸ” [BACKEND] Guard 2 - MyPy strict mode
        run: |
          echo "=== BACKEND GUARD 2: MyPy strict mode ==="

          if ! grep -q "^strict = true" backend/pyproject.toml 2>/dev/null; then
            echo "âŒ BLOCKED: MyPy strict mode not enabled!"
            echo ""
            echo "ğŸš¨ VIOLATION TYPE: Type Safety Weakening"
            exit 1
          fi

          echo "âœ… MyPy strict mode enabled"

      - name: ğŸ” [BACKEND] Guard 3 - No noqa in code
        run: |
          echo "=== BACKEND GUARD 3: No noqa comments ==="

          # Allow noqa only in specific patterns (e.g., imports in __init__.py)
          if grep -rn "# noqa" backend/ 2>/dev/null | grep -v "__init__.py" | grep -v "# noqa: F401"; then
            echo "âŒ BLOCKED: Found unauthorized noqa comments!"
            echo ""
            echo "Allowed: # noqa: F401 in __init__.py for re-exports"
            echo ""
            echo "ğŸš¨ VIOLATION TYPE: Inline Rule Bypass"
            exit 1
          fi

          echo "âœ… No forbidden noqa comments"

      - name: ğŸ” [BACKEND] Guard 4 - Security rules enabled
        run: |
          echo "=== BACKEND GUARD 4: Security rules (bandit) enabled ==="

          if ! grep -q '"S"' backend/pyproject.toml 2>/dev/null; then
            echo "âŒ BLOCKED: Security rules (S/bandit) not enabled!"
            echo ""
            echo "ğŸš¨ VIOLATION TYPE: Security Rules Disabled"
            exit 1
          fi

          echo "âœ… Security rules enabled"

      - name: ğŸ” [BACKEND] Guard 5 - No print statements rule
        run: |
          echo "=== BACKEND GUARD 5: Print statements banned ==="

          if ! grep -q '"T20"' backend/pyproject.toml 2>/dev/null; then
            echo "âŒ BLOCKED: T20 (flake8-print) not enabled!"
            echo ""
            echo "ğŸš¨ VIOLATION TYPE: Debug Code Allowed"
            exit 1
          fi

          echo "âœ… Print statements rule enabled"

      - name: âœ… All guards passed
        run: |
          echo ""
          echo "========================================"
          echo "ğŸ›¡ï¸ ALL CONFIGURATION GUARDS PASSED"
          echo "========================================"
          echo ""
          echo "Frontend guards:"
          echo "  âœ… No warning severity rules"
          echo "  âœ… Max 3 disabled rules"
          echo "  âœ… No eslint-disable abuse"
          echo "  âœ… Minimum 30 active rules"
          echo "  âœ… TypeScript strict mode"
          echo ""
          echo "Backend guards:"
          echo "  âœ… Max 5 ignored Ruff rules"
          echo "  âœ… MyPy strict mode"
          echo "  âœ… No noqa abuse"
          echo "  âœ… Security rules enabled"
          echo "  âœ… Print statements banned"
          echo ""

  # =====================================================
  # JOB 2: Frontend Code Quality
  # =====================================================
  frontend-quality:
    name: ğŸ” Frontend Quality
    runs-on: ubuntu-latest
    needs: config-guard
    defaults:
      run:
        working-directory: frontend
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: ğŸ“‹ TypeScript type checking
        run: npm run typecheck

      - name: ğŸ” ESLint (strict mode)
        run: npm run lint

      - name: ğŸ“ Prettier format check
        run: npm run format:check

  # =====================================================
  # JOB 3: Backend Code Quality
  # =====================================================
  backend-quality:
    name: ğŸ” Backend Quality
    runs-on: ubuntu-latest
    needs: config-guard
    defaults:
      run:
        working-directory: backend
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: ğŸ” Ruff linting (strict mode)
        run: ruff check . --output-format=github

      - name: ğŸ“ Black format check
        run: black --check .

      - name: ğŸ“‹ MyPy type checking
        run: mypy . --ignore-missing-imports

  # =====================================================
  # JOB 4: Frontend Tests
  # =====================================================
  frontend-tests:
    name: ğŸ§ª Frontend Tests
    runs-on: ubuntu-latest
    needs: frontend-quality
    defaults:
      run:
        working-directory: frontend
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: ğŸ§ª Run tests with coverage
        run: npm run test:coverage

      - name: ğŸ“Š Check coverage threshold
        run: |
          if [ -f coverage/coverage-summary.json ]; then
            COVERAGE=$(cat coverage/coverage-summary.json | jq '.total.lines.pct')
            echo "Coverage: $COVERAGE%"

            if (( $(echo "$COVERAGE < $COVERAGE_THRESHOLD" | bc -l) )); then
              echo "âŒ Coverage ($COVERAGE%) below threshold ($COVERAGE_THRESHOLD%)"
              exit 1
            fi

            echo "âœ… Coverage meets threshold"
          else
            echo "âš ï¸ No coverage report found (tests may not exist yet)"
          fi

      - name: Upload coverage
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: frontend-coverage
          path: frontend/coverage/

  # =====================================================
  # JOB 5: Backend Tests
  # =====================================================
  backend-tests:
    name: ğŸ§ª Backend Tests
    runs-on: ubuntu-latest
    needs: backend-quality
    defaults:
      run:
        working-directory: backend
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: ğŸ§ª Run tests with coverage
        run: |
          if [ -d tests ] && [ "$(ls -A tests 2>/dev/null)" ]; then
            pytest --cov=. --cov-report=json --cov-report=html --cov-fail-under=$COVERAGE_THRESHOLD
          else
            echo "âš ï¸ No tests directory found (tests may not exist yet)"
          fi

      - name: Upload coverage
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: backend-coverage
          path: backend/htmlcov/

  # =====================================================
  # JOB 6: Build
  # =====================================================
  build:
    name: ğŸ—ï¸ Build
    runs-on: ubuntu-latest
    needs: [frontend-quality, backend-quality]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # Frontend build
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install frontend dependencies
        working-directory: frontend
        run: npm ci

      - name: ğŸ—ï¸ Build frontend
        working-directory: frontend
        run: npm run build

      - name: Upload frontend build
        uses: actions/upload-artifact@v4
        with:
          name: frontend-dist
          path: frontend/dist/

      # Backend validation
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Validate backend
        working-directory: backend
        run: |
          python -m pip install --upgrade pip
          pip install -e .
          python -c "from monitoring_app import app; print('âœ… Backend imports successfully')"

  # =====================================================
  # JOB 7: Deploy (main branch only)
  # =====================================================
  deploy:
    name: ğŸš€ Deploy
    runs-on: ubuntu-latest
    needs: [frontend-tests, backend-tests, build]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          name: frontend-dist
          path: dist/

      - name: ğŸš€ Deploy notification
        run: |
          echo "========================================"
          echo "ğŸš€ READY FOR DEPLOYMENT"
          echo "========================================"
          echo ""
          echo "All checks passed:"
          echo "  âœ… Configuration guards"
          echo "  âœ… Frontend quality (ESLint, TypeScript, Prettier)"
          echo "  âœ… Backend quality (Ruff, Black, MyPy)"
          echo "  âœ… Frontend tests"
          echo "  âœ… Backend tests"
          echo "  âœ… Production builds"
          echo ""
          echo "Add deployment provider configuration here"
