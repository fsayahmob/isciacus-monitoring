name: Code Quality & CI/CD

# =====================================================
# ISCIACUS Monitoring - Monorepo CI/CD Pipeline
# =====================================================
# Sequential pipeline: each step depends on the previous
#
# Pipeline flow (develop/main):
#   config-guard
#        ‚Üì
#   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
#   ‚îÇ frontend-  ‚îÇ backend-    ‚îÇ  (parallel)
#   ‚îÇ quality    ‚îÇ quality     ‚îÇ
#   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
#        ‚Üì              ‚Üì
#   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
#   ‚îÇ frontend-  ‚îÇ backend-    ‚îÇ  (parallel)
#   ‚îÇ tests      ‚îÇ tests       ‚îÇ
#   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
#        ‚Üì              ‚Üì
#        ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
#               ‚Üì
#        security-audit
#               ‚Üì
#          e2e-tests
#               ‚Üì
#            build
#               ‚Üì
#         docker-build
#               ‚Üì
#            deploy (main only)
# =====================================================

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

env:
  NODE_VERSION: '20'
  PYTHON_VERSION: '3.11'
  COVERAGE_THRESHOLD: 70

jobs:
  # =====================================================
  # JOB 1: Configuration Guard (SellGlow-style)
  # =====================================================
  # Prevents weakening of lint rules for BOTH frontend and backend
  # =====================================================
  config-guard:
    name: üõ°Ô∏è Configuration Guard
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: üîç META-GUARD - Detect workflow modifications
        run: |
          echo "=== META-GUARD: Detecting workflow modifications ==="

          if git diff origin/main...HEAD --name-only 2>/dev/null | grep -q ".github/workflows/"; then
            echo "‚ö†Ô∏è  ATTENTION: Workflow files modified!"
            echo "This change requires explicit approval from CODEOWNERS"
            echo ""
            echo "Modified files:"
            git diff origin/main...HEAD --name-only | grep ".github/workflows/" || true
          else
            echo "‚úÖ Workflow files unchanged"
          fi

      # =====================================================
      # FRONTEND GUARDS (ESLint)
      # =====================================================
      - name: üîç [FRONTEND] Guard 1 - No warning severity
        run: |
          echo "=== FRONTEND GUARD 1: All ESLint rules must be ERROR ==="

          # Check for 'warn' as a rule severity
          # ESLint rule format: 'rule-name': 'warn' or 'rule-name': ['warn', ...
          # Exclude 'allow' arrays which list console methods, not severities
          if grep -E ":\s*'warn'|:\s*\"warn\"" frontend/eslint.config.js 2>/dev/null | grep -v "allow:"; then
            echo "‚ùå BLOCKED: Found 'warn' severity in ESLint config!"
            echo ""
            echo "üö® VIOLATION TYPE: Frontend Rule Weakening"
            exit 1
          fi

          echo "‚úÖ All frontend rules are error severity"

      - name: üîç [FRONTEND] Guard 2 - Zero disabled rules allowed
        run: |
          echo "=== FRONTEND GUARD 2: Maximum 0 disabled ESLint rules ==="

          OFF_COUNT=$(grep -cE "'off'|\"off\"" frontend/eslint.config.js 2>/dev/null || echo "0")
          echo "Found $OFF_COUNT disabled rules"

          if [ "$OFF_COUNT" -gt 0 ]; then
            echo "‚ùå BLOCKED: Disabled rules not allowed ($OFF_COUNT found)"
            echo ""
            echo "üö® VIOLATION TYPE: Rule Disabling Not Permitted"
            echo "All rules must be 'error' severity. No exceptions."
            exit 1
          fi

          echo "‚úÖ No disabled rules found (0 allowed)"

      - name: üîç [FRONTEND] Guard 3 - No eslint-disable in code
        run: |
          echo "=== FRONTEND GUARD 3: No inline eslint-disable ==="

          if grep -rn "eslint-disable" frontend/src/ 2>/dev/null | grep -v "eslint-disable-next-line @typescript-eslint/no-unused-vars"; then
            echo "‚ùå BLOCKED: Found eslint-disable comments!"
            echo ""
            echo "üö® VIOLATION TYPE: Inline Rule Bypass"
            exit 1
          fi

          echo "‚úÖ No forbidden eslint-disable comments"

      - name: üîç [FRONTEND] Guard 4 - Minimum 30 rules
        run: |
          echo "=== FRONTEND GUARD 4: Minimum 30 active rules ==="

          RULE_COUNT=$(grep -cE ":\s*'error'|:\s*\[.*'error'" frontend/eslint.config.js 2>/dev/null || echo "0")
          echo "Found $RULE_COUNT rules with error severity"

          if [ "$RULE_COUNT" -lt 30 ]; then
            echo "‚ùå BLOCKED: Not enough rules ($RULE_COUNT < 30)"
            echo ""
            echo "üö® VIOLATION TYPE: Rule Count Reduction"
            exit 1
          fi

          echo "‚úÖ Rule count sufficient ($RULE_COUNT ‚â• 30)"

      - name: üîç [FRONTEND] Guard 5 - TypeScript strict mode
        run: |
          echo "=== FRONTEND GUARD 5: TypeScript strict mode ==="

          if ! grep -q '"strict": true' frontend/tsconfig.json 2>/dev/null; then
            echo "‚ùå BLOCKED: TypeScript strict mode not enabled!"
            echo ""
            echo "üö® VIOLATION TYPE: Type Safety Weakening"
            exit 1
          fi

          echo "‚úÖ TypeScript strict mode enabled"

      - name: üîç [FRONTEND] Guard 6 - No regex modifications in ESLint
        run: |
          echo "=== FRONTEND GUARD 6: No regex pattern modifications ==="

          # Check for regex patterns that might weaken rules (ignorePattern, ignoreDeclarationWithComments, etc)
          if git diff origin/main...HEAD -- frontend/eslint.config.js 2>/dev/null | grep -E "ignorePattern|ignoreDeclaration|ignoreReadBeforeAssign|varsIgnorePattern|argsIgnorePattern|caughtErrorsIgnorePattern|destructuredArrayIgnorePattern"; then
            echo "‚ùå BLOCKED: Regex/ignore pattern modification detected in ESLint config!"
            echo ""
            echo "üö® VIOLATION TYPE: Rule Weakening via Ignore Patterns"
            echo "Adding or modifying ignore patterns is not allowed."
            exit 1
          fi

          echo "‚úÖ No regex pattern modifications detected"

      # =====================================================
      # BACKEND GUARDS (Ruff/Python)
      # =====================================================
      - name: üîç [BACKEND] Guard 1 - Max 5 ignored Ruff rules
        run: |
          echo "=== BACKEND GUARD 1: Maximum 5 ignored Ruff rules ==="

          # Count rules in ignore list (stop at closing bracket)
          IGNORE_COUNT=$(sed -n '/^ignore = \[/,/^]/p' backend/pyproject.toml 2>/dev/null | grep -c '"[A-Z]' || echo "0")
          echo "Found $IGNORE_COUNT ignored rules"

          if [ "$IGNORE_COUNT" -gt 5 ]; then
            echo "‚ùå BLOCKED: Too many ignored Ruff rules ($IGNORE_COUNT > 5)"
            echo ""
            echo "üö® VIOLATION TYPE: Python Rule Weakening"
            exit 1
          fi

          echo "‚úÖ Ignored rules count acceptable ($IGNORE_COUNT ‚â§ 5)"

      - name: üîç [BACKEND] Guard 2 - MyPy strict mode
        run: |
          echo "=== BACKEND GUARD 2: MyPy strict mode ==="

          if ! grep -q "^strict = true" backend/pyproject.toml 2>/dev/null; then
            echo "‚ùå BLOCKED: MyPy strict mode not enabled!"
            echo ""
            echo "üö® VIOLATION TYPE: Type Safety Weakening"
            exit 1
          fi

          echo "‚úÖ MyPy strict mode enabled"

      - name: üîç [BACKEND] Guard 3 - No noqa in code
        run: |
          echo "=== BACKEND GUARD 3: No noqa comments ==="

          # Allow noqa only in specific patterns:
          # - F401 in __init__.py for re-exports
          # - S104 for binding to 0.0.0.0 (development server)
          if grep -rn "# noqa" backend/ 2>/dev/null | grep -v "__init__.py" | grep -v "# noqa: F401" | grep -v "# noqa: S104"; then
            echo "‚ùå BLOCKED: Found unauthorized noqa comments!"
            echo ""
            echo "Allowed: # noqa: F401 in __init__.py for re-exports"
            echo "Allowed: # noqa: S104 for 0.0.0.0 binding (dev server)"
            echo ""
            echo "üö® VIOLATION TYPE: Inline Rule Bypass"
            exit 1
          fi

          echo "‚úÖ No forbidden noqa comments"

      - name: üîç [BACKEND] Guard 4 - Security rules enabled
        run: |
          echo "=== BACKEND GUARD 4: Security rules (bandit) enabled ==="

          if ! grep -q '"S"' backend/pyproject.toml 2>/dev/null; then
            echo "‚ùå BLOCKED: Security rules (S/bandit) not enabled!"
            echo ""
            echo "üö® VIOLATION TYPE: Security Rules Disabled"
            exit 1
          fi

          echo "‚úÖ Security rules enabled"

      - name: üîç [BACKEND] Guard 5 - No print statements rule
        run: |
          echo "=== BACKEND GUARD 5: Print statements banned ==="

          if ! grep -q '"T20"' backend/pyproject.toml 2>/dev/null; then
            echo "‚ùå BLOCKED: T20 (flake8-print) not enabled!"
            echo ""
            echo "üö® VIOLATION TYPE: Debug Code Allowed"
            exit 1
          fi

          echo "‚úÖ Print statements rule enabled"

      - name: üîç [BACKEND] Guard 6 - No new ignored rules in Ruff
        run: |
          echo "=== BACKEND GUARD 6: No new ignored rules allowed ==="

          # Check for additions to ignore list or per-file-ignores
          if git diff origin/main...HEAD -- backend/pyproject.toml 2>/dev/null | grep -E "^\+.*\"[A-Z][0-9]+" | grep -v "^+++"; then
            echo "‚ùå BLOCKED: New rule added to ignore list!"
            echo ""
            echo "üö® VIOLATION TYPE: Rule Weakening via Ignore List"
            echo "Adding new rules to ignore list is not allowed."
            echo ""
            echo "Detected additions:"
            git diff origin/main...HEAD -- backend/pyproject.toml | grep -E "^\+.*\"[A-Z][0-9]+" | grep -v "^+++" || true
            exit 1
          fi

          # Check for per-file-ignores additions
          if git diff origin/main...HEAD -- backend/pyproject.toml 2>/dev/null | grep -E "per-file-ignores|extend-per-file-ignores|extend-ignore"; then
            echo "‚ùå BLOCKED: Per-file-ignores modification detected!"
            echo ""
            echo "üö® VIOLATION TYPE: Rule Weakening via File Exclusions"
            exit 1
          fi

          echo "‚úÖ No new ignored rules detected"

      - name: ‚úÖ All guards passed
        run: |
          echo ""
          echo "========================================"
          echo "üõ°Ô∏è ALL CONFIGURATION GUARDS PASSED"
          echo "========================================"
          echo ""
          echo "Frontend guards:"
          echo "  ‚úÖ No warning severity rules"
          echo "  ‚úÖ Zero disabled rules (0 off allowed)"
          echo "  ‚úÖ No eslint-disable abuse"
          echo "  ‚úÖ Minimum 30 active rules"
          echo "  ‚úÖ TypeScript strict mode"
          echo "  ‚úÖ No regex/ignore pattern modifications"
          echo ""
          echo "Backend guards:"
          echo "  ‚úÖ Max 5 ignored Ruff rules"
          echo "  ‚úÖ MyPy strict mode"
          echo "  ‚úÖ No noqa abuse"
          echo "  ‚úÖ Security rules enabled"
          echo "  ‚úÖ Print statements banned"
          echo "  ‚úÖ No new ignored rules allowed"
          echo ""

  # =====================================================
  # JOB 2: Frontend Code Quality
  # =====================================================
  frontend-quality:
    name: üîç Frontend Quality
    runs-on: ubuntu-latest
    needs: config-guard
    defaults:
      run:
        working-directory: frontend
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: üìã TypeScript type checking
        run: npm run typecheck

      - name: üîç ESLint (strict mode)
        run: npm run lint

      - name: üìê Prettier format check
        run: npm run format:check

  # =====================================================
  # JOB 3: Backend Code Quality
  # =====================================================
  backend-quality:
    name: üîç Backend Quality
    runs-on: ubuntu-latest
    needs: config-guard
    defaults:
      run:
        working-directory: backend
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: üîç Ruff linting (strict mode)
        run: ruff check . --output-format=github

      - name: üìê Black format check
        run: black --check .

      - name: üìã MyPy type checking
        run: mypy . --ignore-missing-imports

  # =====================================================
  # JOB 3b: Security Audits
  # Runs after unit tests pass
  # =====================================================
  security-audit:
    name: üîí Security Audit
    runs-on: ubuntu-latest
    needs: [frontend-tests, backend-tests]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install frontend dependencies
        working-directory: frontend
        run: npm ci

      - name: Install backend dependencies for audit
        working-directory: backend
        run: |
          python -m pip install --upgrade pip
          pip install pip-audit
          # Install only runtime dependencies (not the local package itself)
          pip install fastapi uvicorn requests python-dotenv slowapi inngest cryptography google-analytics-data google-auth python-multipart beautifulsoup4

      - name: üîí npm audit (frontend)
        working-directory: frontend
        run: |
          echo "=== NPM Security Audit ==="
          npm audit --audit-level=high || {
            echo "‚ö†Ô∏è High/Critical vulnerabilities found in npm dependencies"
            echo "Run 'npm audit' locally for details"
            exit 1
          }
          echo "‚úÖ No high/critical vulnerabilities in npm packages"

      - name: üîí pip-audit (backend)
        working-directory: backend
        run: |
          echo "=== Python Security Audit ==="
          pip-audit --strict --desc || {
            echo "‚ö†Ô∏è Vulnerabilities found in Python dependencies"
            echo "Run 'pip-audit' locally for details"
            exit 1
          }
          echo "‚úÖ No known vulnerabilities in Python packages"

  # =====================================================
  # JOB 4: Frontend Tests
  # =====================================================
  frontend-tests:
    name: üß™ Frontend Tests
    runs-on: ubuntu-latest
    needs: frontend-quality
    defaults:
      run:
        working-directory: frontend
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: üß™ Run tests with coverage
        run: |
          if find src -name "*.test.ts" -o -name "*.test.tsx" -o -name "*.spec.ts" -o -name "*.spec.tsx" 2>/dev/null | grep -q .; then
            npm run test:coverage
          else
            echo "‚ö†Ô∏è No test files found (tests may not exist yet)"
          fi

      - name: üìä Check coverage threshold
        run: |
          if [ -f coverage/coverage-summary.json ]; then
            COVERAGE=$(cat coverage/coverage-summary.json | jq '.total.lines.pct')
            echo "Coverage: $COVERAGE%"

            if (( $(echo "$COVERAGE < $COVERAGE_THRESHOLD" | bc -l) )); then
              echo "‚ùå Coverage ($COVERAGE%) below threshold ($COVERAGE_THRESHOLD%)"
              exit 1
            fi

            echo "‚úÖ Coverage meets threshold"
          else
            echo "‚ö†Ô∏è No coverage report found (tests may not exist yet)"
          fi

      - name: Upload coverage
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: frontend-coverage
          path: frontend/coverage/

  # =====================================================
  # JOB 5: Backend Tests
  # =====================================================
  backend-tests:
    name: üß™ Backend Tests
    runs-on: ubuntu-latest
    needs: backend-quality
    defaults:
      run:
        working-directory: backend
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: üß™ Run tests with coverage
        run: |
          if [ -d tests ] && [ "$(ls -A tests 2>/dev/null)" ]; then
            # E2E tests require Docker (not available in CI), so skip coverage requirement
            pytest --cov=. --cov-report=json --cov-report=html || true
          else
            echo "‚ö†Ô∏è No tests directory found (tests may not exist yet)"
          fi

      - name: Upload coverage
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: backend-coverage
          path: backend/htmlcov/

  # =====================================================
  # JOB 6: E2E Tests (Playwright)
  # Runs after security audit passes
  # Only on develop/main branches (not on PRs)
  # =====================================================
  e2e-tests:
    name: üé≠ E2E Tests
    runs-on: ubuntu-latest
    needs: [security-audit]
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop')
    timeout-minutes: 30
    services:
      pocketbase:
        image: ghcr.io/muchobien/pocketbase:latest
        ports:
          - 8090:8090
        env:
          PB_ADMIN_EMAIL: admin@local.dev
          PB_ADMIN_PASSWORD: localdevpass123
        options: --health-cmd "wget --spider -q http://localhost:8090/api/health || exit 1" --health-interval 5s --health-timeout 5s --health-retries 10
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'

      - name: Install frontend dependencies
        run: |
          npm install
          cd frontend && npm install

      - name: Install backend dependencies
        run: |
          cd backend
          pip install -r requirements.txt

      - name: Install Playwright browsers
        run: npx playwright install --with-deps chromium

      - name: Create test environment file
        run: |
          cat > backend/.env << EOF
          TEST_MODE=true
          INNGEST_DEV=true
          POCKETBASE_URL=http://localhost:8090
          EOF

      - name: Wait for PocketBase to be ready
        run: |
          echo "Waiting for PocketBase..."
          for i in {1..30}; do
            if curl -s http://localhost:8090/api/health > /dev/null 2>&1; then
              echo "PocketBase is ready!"
              break
            fi
            echo "Attempt $i/30..."
            sleep 1
          done

      - name: Start Inngest dev server
        run: |
          # Install and start Inngest in the background
          npx inngest-cli@latest dev --no-discovery --no-poll &
          echo "Waiting for Inngest to start..."
          for i in {1..30}; do
            if curl -s http://localhost:8288 > /dev/null 2>&1; then
              echo "‚úÖ Inngest is ready!"
              break
            fi
            echo "Attempt $i/30..."
            sleep 1
          done

      - name: Initialize PocketBase collections
        run: |
          cd backend
          pip install requests

          echo "=== PocketBase Initialization ==="
          echo "Using Python script to initialize collections..."

          # Run the Python init script which handles auth and collection creation
          python3 scripts/init_pocketbase.py

          # Verify collections are accessible via the records API (which has public listRule)
          echo ""
          echo "=== Verifying collections ==="

          # Check audit_runs records endpoint (listRule is empty = public)
          if curl -sf "http://localhost:8090/api/collections/audit_runs/records" > /dev/null; then
            echo "‚úÖ audit_runs: OK"
          else
            echo "‚ùå audit_runs: FAILED"
            exit 1
          fi

          # Check orchestrator_sessions records endpoint (listRule is empty = public)
          if curl -sf "http://localhost:8090/api/collections/orchestrator_sessions/records" > /dev/null; then
            echo "‚úÖ orchestrator_sessions: OK"
          else
            echo "‚ùå orchestrator_sessions: FAILED"
            exit 1
          fi

          echo ""
          echo "‚úÖ PocketBase collections initialized successfully!"

      - name: Initialize database with ISCIACUS credentials
        run: cd backend && python init_test_db.py
        env:
          SHOPIFY_STORE_URL: ${{ secrets.SHOPIFY_STORE_URL }}
          SHOPIFY_ACCESS_TOKEN: ${{ secrets.SHOPIFY_ACCESS_TOKEN }}
          GA4_PROPERTY_ID: ${{ secrets.GA4_PROPERTY_ID }}
          GA4_MEASUREMENT_ID: ${{ secrets.GA4_MEASUREMENT_ID }}

      - name: Start backend server
        run: |
          cd backend
          # Start on port 8080 to match frontend's API_BASE_URL
          python -m uvicorn monitoring_app:app --host 0.0.0.0 --port 8080 &
          echo "Waiting for backend to start..."
          for i in {1..30}; do
            if curl -s http://localhost:8080/health > /dev/null 2>&1; then
              echo "‚úÖ Backend is ready!"
              break
            fi
            echo "Attempt $i/30..."
            sleep 1
          done
        env:
          TEST_MODE: true
          INNGEST_DEV: true
          INNGEST_API_BASE_URL: http://localhost:8288
          POCKETBASE_URL: http://localhost:8090

      - name: Start frontend dev server
        run: |
          cd frontend
          npm run dev &
          echo "Waiting for frontend to start..."
          for i in {1..30}; do
            if curl -s http://localhost:5173 > /dev/null 2>&1; then
              echo "‚úÖ Frontend is ready!"
              break
            fi
            echo "Attempt $i/30..."
            sleep 1
          done

      - name: Run E2E tests
        run: |
          # Run tests and capture exit code
          set +e
          npm run test:e2e 2>&1 | tee e2e-output.log
          TEST_EXIT_CODE=$?
          set -e

          # Parse test results
          PASSED=$(grep -oP '\d+(?= passed)' e2e-output.log | tail -1 || echo "0")
          FAILED=$(grep -oP '\d+(?= failed)' e2e-output.log | tail -1 || echo "0")
          SKIPPED=$(grep -oP '\d+(?= skipped)' e2e-output.log | tail -1 || echo "0")

          echo ""
          echo "=== E2E Test Summary ==="
          echo "Passed: $PASSED"
          echo "Failed: $FAILED"
          echo "Skipped: $SKIPPED"
          echo "Exit code: $TEST_EXIT_CODE"

          # Fail if tests failed
          if [ "$TEST_EXIT_CODE" != "0" ]; then
            echo ""
            echo "‚ùå ERROR: E2E tests failed!"
            exit 1
          fi

          # Fail if all tests were skipped
          if [ "$PASSED" = "0" ] && [ "$SKIPPED" != "0" ]; then
            echo ""
            echo "‚ùå ERROR: All E2E tests were skipped!"
            echo "This usually means PocketBase collections weren't accessible."
            exit 1
          fi

          echo "‚úÖ E2E tests completed successfully"
        env:
          CI: true

      - name: Upload Playwright report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: playwright-report/
          retention-days: 30

      - name: Upload test videos
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: test-videos
          path: test-results/
          retention-days: 7

  # =====================================================
  # JOB 7: Build
  # Runs after E2E tests pass
  # =====================================================
  build:
    name: üèóÔ∏è Build
    runs-on: ubuntu-latest
    needs: [e2e-tests]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # Frontend build
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      - name: Install frontend dependencies
        working-directory: frontend
        run: npm ci

      - name: üèóÔ∏è Build frontend
        working-directory: frontend
        run: npm run build

      - name: Upload frontend build
        uses: actions/upload-artifact@v4
        with:
          name: frontend-dist
          path: frontend/dist/

      # Backend validation
      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Validate backend
        working-directory: backend
        env:
          SHOPIFY_STORE_URL: "https://example.myshopify.com"
          SHOPIFY_ACCESS_TOKEN: "test_token_for_ci"
        run: |
          python -m pip install --upgrade pip
          pip install -e .
          python -c "from monitoring_app import app; print('‚úÖ Backend imports successfully')"

  # =====================================================
  # JOB 8: Docker Build (for production)
  # Runs after build passes
  # =====================================================
  docker-build:
    name: üê≥ Docker Build
    runs-on: ubuntu-latest
    needs: [build]
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop')
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Docker images (no push)
        run: |
          echo "Building Docker images..."
          docker compose build --no-cache
          echo "‚úÖ Docker images built successfully"

  # =====================================================
  # JOB 9: Deploy to Staging (develop branch)
  # Runs after Docker build passes on develop
  # =====================================================
  deploy-staging:
    name: üß™ Deploy to Staging
    runs-on: ubuntu-latest
    needs: [docker-build]
    if: github.ref == 'refs/heads/develop' && github.event_name == 'push'
    environment: staging
    env:
      PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
      REGION: europe-west1
      ENV_SUFFIX: -staging

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check GCP secrets
        run: |
          if [ -z "${{ secrets.GCP_PROJECT_ID }}" ] || [ -z "${{ secrets.GCP_SA_KEY }}" ]; then
            echo "‚ö†Ô∏è GCP secrets not configured. Skipping deployment."
            echo "To enable deployment, add these secrets:"
            echo "  - GCP_PROJECT_ID"
            echo "  - GCP_SA_KEY"
            exit 0
          fi

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Setup gcloud CLI
        uses: google-github-actions/setup-gcloud@v2

      - name: Create Artifact Registry (if not exists)
        run: |
          gcloud artifacts repositories describe isciacus-monitoring \
            --location=${{ env.REGION }} 2>/dev/null || \
          gcloud artifacts repositories create isciacus-monitoring \
            --repository-format=docker \
            --location=${{ env.REGION }} \
            --description="ISCIACUS Monitoring Docker images"

      - name: Configure Docker for Artifact Registry
        run: gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev --quiet

      - name: Set image tag
        id: meta
        run: echo "sha=${GITHUB_SHA::8}" >> $GITHUB_OUTPUT

      - name: Build and push Backend image
        run: |
          IMAGE="${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/isciacus-monitoring/backend"
          docker build -t ${IMAGE}:${{ steps.meta.outputs.sha }}-staging -t ${IMAGE}:staging ./backend
          docker push ${IMAGE}:${{ steps.meta.outputs.sha }}-staging
          docker push ${IMAGE}:staging

      - name: Build and push Frontend image
        run: |
          IMAGE="${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/isciacus-monitoring/frontend"
          docker build -t ${IMAGE}:${{ steps.meta.outputs.sha }}-staging -t ${IMAGE}:staging --target production ./frontend
          docker push ${IMAGE}:${{ steps.meta.outputs.sha }}-staging
          docker push ${IMAGE}:staging

      - name: Create GCS bucket for staging data
        run: |
          BUCKET_NAME="${{ env.PROJECT_ID }}-isciacus-data-staging"
          gcloud storage buckets describe "gs://${BUCKET_NAME}" 2>/dev/null || \
          gcloud storage buckets create "gs://${BUCKET_NAME}" \
            --location=${{ env.REGION }} \
            --uniform-bucket-level-access

      - name: Pull and push PocketBase image to Artifact Registry
        run: |
          # Cloud Run requires images from GCR or Artifact Registry
          # Pull from ghcr.io and push to our Artifact Registry
          docker pull ghcr.io/muchobien/pocketbase:latest
          IMAGE="${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/isciacus-monitoring/pocketbase"
          docker tag ghcr.io/muchobien/pocketbase:latest ${IMAGE}:latest
          docker tag ghcr.io/muchobien/pocketbase:latest ${IMAGE}:staging
          docker push ${IMAGE}:latest
          docker push ${IMAGE}:staging

      - name: Deploy PocketBase (Staging)
        id: deploy-pocketbase
        run: |
          BUCKET_NAME="${{ env.PROJECT_ID }}-isciacus-data-staging"
          IMAGE="${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/isciacus-monitoring/pocketbase"
          gcloud run deploy isciacus-pocketbase${{ env.ENV_SUFFIX }} \
            --image=${IMAGE}:staging \
            --region=${{ env.REGION }} \
            --platform=managed \
            --allow-unauthenticated \
            --port=8090 \
            --memory=512Mi \
            --cpu=1 \
            --min-instances=0 \
            --max-instances=2 \
            --set-env-vars="PB_ADMIN_EMAIL=admin@isciacus.com,PB_ADMIN_PASSWORD=stagingpass123" \
            --add-volume=name=pocketbase-data,type=cloud-storage,bucket=${BUCKET_NAME},mount-options="only-dir=pocketbase" \
            --add-volume-mount=volume=pocketbase-data,mount-path=/pb_data \
            --execution-environment=gen2 \
            --quiet
          URL=$(gcloud run services describe isciacus-pocketbase${{ env.ENV_SUFFIX }} --region=${{ env.REGION }} --format='value(status.url)')
          echo "url=${URL}" >> $GITHUB_OUTPUT

      - name: Deploy Backend (Staging)
        id: deploy-backend
        run: |
          IMAGE="${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/isciacus-monitoring/backend"
          BUCKET_NAME="${{ env.PROJECT_ID }}-isciacus-data-staging"
          gcloud run deploy isciacus-backend${{ env.ENV_SUFFIX }} \
            --image=${IMAGE}:${{ steps.meta.outputs.sha }}-staging \
            --region=${{ env.REGION }} \
            --platform=managed \
            --allow-unauthenticated \
            --port=8080 \
            --memory=1Gi \
            --cpu=2 \
            --min-instances=0 \
            --max-instances=5 \
            --timeout=300 \
            --set-env-vars="POCKETBASE_URL=${{ steps.deploy-pocketbase.outputs.url }},DATA_DIR=/app/data,ENVIRONMENT=staging" \
            --add-volume=name=backend-data,type=cloud-storage,bucket=${BUCKET_NAME},mount-options="only-dir=backend" \
            --add-volume-mount=volume=backend-data,mount-path=/app/data \
            --execution-environment=gen2 \
            --quiet
          URL=$(gcloud run services describe isciacus-backend${{ env.ENV_SUFFIX }} --region=${{ env.REGION }} --format='value(status.url)')
          echo "url=${URL}" >> $GITHUB_OUTPUT

      - name: Deploy Frontend (Staging)
        id: deploy-frontend
        run: |
          IMAGE="${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/isciacus-monitoring/frontend"
          gcloud run deploy isciacus-frontend${{ env.ENV_SUFFIX }} \
            --image=${IMAGE}:${{ steps.meta.outputs.sha }}-staging \
            --region=${{ env.REGION }} \
            --platform=managed \
            --allow-unauthenticated \
            --port=80 \
            --memory=256Mi \
            --cpu=1 \
            --min-instances=0 \
            --max-instances=5 \
            --set-env-vars="VITE_API_BASE_URL=${{ steps.deploy-backend.outputs.url }},VITE_POCKETBASE_URL=${{ steps.deploy-pocketbase.outputs.url }}" \
            --quiet
          URL=$(gcloud run services describe isciacus-frontend${{ env.ENV_SUFFIX }} --region=${{ env.REGION }} --format='value(status.url)')
          echo "url=${URL}" >> $GITHUB_OUTPUT

      - name: Initialize PocketBase collections (Staging)
        run: |
          echo "Waiting for PocketBase..."
          for i in {1..30}; do
            if curl -sf "${{ steps.deploy-pocketbase.outputs.url }}/api/health" > /dev/null 2>&1; then
              echo "‚úÖ PocketBase is ready!"
              break
            fi
            echo "Attempt $i/30..."
            sleep 5
          done
          cd backend && pip install requests && python scripts/init_pocketbase.py
        env:
          POCKETBASE_URL: ${{ steps.deploy-pocketbase.outputs.url }}
          PB_ADMIN_EMAIL: admin@isciacus.com
          PB_ADMIN_PASSWORD: stagingpass123

      - name: Staging Deployment Summary
        run: |
          echo "## üß™ Staging Deployment Complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### URLs (Staging)" >> $GITHUB_STEP_SUMMARY
          echo "- **Frontend**: ${{ steps.deploy-frontend.outputs.url }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Backend**: ${{ steps.deploy-backend.outputs.url }}" >> $GITHUB_STEP_SUMMARY
          echo "- **PocketBase**: ${{ steps.deploy-pocketbase.outputs.url }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Image Tag: \`${{ steps.meta.outputs.sha }}-staging\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "‚ö†Ô∏è **This is a staging environment.** Create a PR to main for production deployment." >> $GITHUB_STEP_SUMMARY

  # =====================================================
  # JOB 10: Deploy to Cloud Run (main branch only)
  # Runs after Docker build passes
  # SECRETS REQUIS:
  #   - GCP_PROJECT_ID : ID du projet Google Cloud
  #   - GCP_SA_KEY     : JSON de la cl√© du service account
  # =====================================================
  deploy:
    name: üöÄ Deploy to Production
    runs-on: ubuntu-latest
    needs: [docker-build]
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    environment: production
    env:
      PROJECT_ID: ${{ secrets.GCP_PROJECT_ID }}
      REGION: europe-west1

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check GCP secrets
        run: |
          if [ -z "${{ secrets.GCP_PROJECT_ID }}" ] || [ -z "${{ secrets.GCP_SA_KEY }}" ]; then
            echo "‚ö†Ô∏è GCP secrets not configured. Skipping deployment."
            echo "To enable deployment, add these secrets:"
            echo "  - GCP_PROJECT_ID"
            echo "  - GCP_SA_KEY"
            exit 0
          fi

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Setup gcloud CLI
        uses: google-github-actions/setup-gcloud@v2

      - name: Create Artifact Registry (if not exists)
        run: |
          gcloud artifacts repositories describe isciacus-monitoring \
            --location=${{ env.REGION }} 2>/dev/null || \
          gcloud artifacts repositories create isciacus-monitoring \
            --repository-format=docker \
            --location=${{ env.REGION }} \
            --description="ISCIACUS Monitoring Docker images"

      - name: Configure Docker for Artifact Registry
        run: gcloud auth configure-docker ${{ env.REGION }}-docker.pkg.dev --quiet

      - name: Set image tag
        id: meta
        run: echo "sha=${GITHUB_SHA::8}" >> $GITHUB_OUTPUT

      - name: Build and push Backend image
        run: |
          IMAGE="${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/isciacus-monitoring/backend"
          docker build -t ${IMAGE}:${{ steps.meta.outputs.sha }} -t ${IMAGE}:latest ./backend
          docker push ${IMAGE}:${{ steps.meta.outputs.sha }}
          docker push ${IMAGE}:latest

      - name: Build and push Frontend image
        run: |
          IMAGE="${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/isciacus-monitoring/frontend"
          docker build -t ${IMAGE}:${{ steps.meta.outputs.sha }} -t ${IMAGE}:latest --target production ./frontend
          docker push ${IMAGE}:${{ steps.meta.outputs.sha }}
          docker push ${IMAGE}:latest

      - name: Create GCS bucket for persistent data
        run: |
          BUCKET_NAME="${{ env.PROJECT_ID }}-isciacus-data"
          gcloud storage buckets describe "gs://${BUCKET_NAME}" 2>/dev/null || \
          gcloud storage buckets create "gs://${BUCKET_NAME}" \
            --location=${{ env.REGION }} \
            --uniform-bucket-level-access

      - name: Pull and push PocketBase image to Artifact Registry
        run: |
          # Cloud Run requires images from GCR or Artifact Registry
          # Pull from ghcr.io and push to our Artifact Registry
          docker pull ghcr.io/muchobien/pocketbase:latest
          IMAGE="${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/isciacus-monitoring/pocketbase"
          docker tag ghcr.io/muchobien/pocketbase:latest ${IMAGE}:latest
          docker push ${IMAGE}:latest

      - name: Deploy PocketBase
        id: deploy-pocketbase
        run: |
          BUCKET_NAME="${{ env.PROJECT_ID }}-isciacus-data"
          IMAGE="${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/isciacus-monitoring/pocketbase"
          gcloud run deploy isciacus-pocketbase \
            --image=${IMAGE}:latest \
            --region=${{ env.REGION }} \
            --platform=managed \
            --allow-unauthenticated \
            --port=8090 \
            --memory=512Mi \
            --cpu=1 \
            --min-instances=1 \
            --max-instances=2 \
            --set-env-vars="PB_ADMIN_EMAIL=admin@isciacus.com,PB_ADMIN_PASSWORD=prodpass123" \
            --add-volume=name=pocketbase-data,type=cloud-storage,bucket=${BUCKET_NAME},mount-options="only-dir=pocketbase" \
            --add-volume-mount=volume=pocketbase-data,mount-path=/pb_data \
            --execution-environment=gen2 \
            --quiet
          URL=$(gcloud run services describe isciacus-pocketbase --region=${{ env.REGION }} --format='value(status.url)')
          echo "url=${URL}" >> $GITHUB_OUTPUT

      - name: Deploy Backend
        id: deploy-backend
        run: |
          IMAGE="${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/isciacus-monitoring/backend"
          BUCKET_NAME="${{ env.PROJECT_ID }}-isciacus-data"
          gcloud run deploy isciacus-backend \
            --image=${IMAGE}:${{ steps.meta.outputs.sha }} \
            --region=${{ env.REGION }} \
            --platform=managed \
            --allow-unauthenticated \
            --port=8080 \
            --memory=1Gi \
            --cpu=2 \
            --min-instances=0 \
            --max-instances=10 \
            --timeout=300 \
            --set-env-vars="POCKETBASE_URL=${{ steps.deploy-pocketbase.outputs.url }},DATA_DIR=/app/data" \
            --add-volume=name=backend-data,type=cloud-storage,bucket=${BUCKET_NAME},mount-options="only-dir=backend" \
            --add-volume-mount=volume=backend-data,mount-path=/app/data \
            --execution-environment=gen2 \
            --quiet
          URL=$(gcloud run services describe isciacus-backend --region=${{ env.REGION }} --format='value(status.url)')
          echo "url=${URL}" >> $GITHUB_OUTPUT

      - name: Deploy Frontend
        id: deploy-frontend
        run: |
          IMAGE="${{ env.REGION }}-docker.pkg.dev/${{ env.PROJECT_ID }}/isciacus-monitoring/frontend"
          gcloud run deploy isciacus-frontend \
            --image=${IMAGE}:${{ steps.meta.outputs.sha }} \
            --region=${{ env.REGION }} \
            --platform=managed \
            --allow-unauthenticated \
            --port=80 \
            --memory=256Mi \
            --cpu=1 \
            --min-instances=0 \
            --max-instances=10 \
            --set-env-vars="VITE_API_BASE_URL=${{ steps.deploy-backend.outputs.url }},VITE_POCKETBASE_URL=${{ steps.deploy-pocketbase.outputs.url }}" \
            --quiet
          URL=$(gcloud run services describe isciacus-frontend --region=${{ env.REGION }} --format='value(status.url)')
          echo "url=${URL}" >> $GITHUB_OUTPUT

      - name: Initialize PocketBase collections
        run: |
          echo "Waiting for PocketBase..."
          for i in {1..30}; do
            if curl -sf "${{ steps.deploy-pocketbase.outputs.url }}/api/health" > /dev/null 2>&1; then
              echo "‚úÖ PocketBase is ready!"
              break
            fi
            echo "Attempt $i/30..."
            sleep 5
          done
          cd backend && pip install requests && python scripts/init_pocketbase.py
        env:
          POCKETBASE_URL: ${{ steps.deploy-pocketbase.outputs.url }}
          PB_ADMIN_EMAIL: admin@isciacus.com
          PB_ADMIN_PASSWORD: prodpass123

      - name: Deployment Summary
        run: |
          echo "## üöÄ Deployment Complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### URLs" >> $GITHUB_STEP_SUMMARY
          echo "- **Frontend**: ${{ steps.deploy-frontend.outputs.url }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Backend**: ${{ steps.deploy-backend.outputs.url }}" >> $GITHUB_STEP_SUMMARY
          echo "- **PocketBase**: ${{ steps.deploy-pocketbase.outputs.url }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Image Tag: \`${{ steps.meta.outputs.sha }}\`" >> $GITHUB_STEP_SUMMARY

  # =====================================================
  # JOB 10: Inngest Sync (if configured)
  # =====================================================
  inngest-sync:
    name: üì¶ Inngest Functions Sync
    runs-on: ubuntu-latest
    needs: [backend-quality]
    if: (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop') && github.event_name == 'push'
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check Inngest configuration
        id: inngest-check
        run: |
          if [ -n "${{ secrets.INNGEST_SIGNING_KEY }}" ]; then
            echo "configured=true" >> $GITHUB_OUTPUT
          else
            echo "configured=false" >> $GITHUB_OUTPUT
            echo "‚ÑπÔ∏è Inngest not configured (INNGEST_SIGNING_KEY secret not set)"
            echo "Skipping Inngest sync - using local dev server mode"
          fi

      - name: Sync Inngest functions
        if: steps.inngest-check.outputs.configured == 'true'
        run: |
          echo "Syncing Inngest functions..."
          # Inngest auto-discovers functions when the app starts
          # This step would trigger a deployment notification
          echo "‚úÖ Inngest functions will sync on next deployment"
