#!/bin/bash

# Hook PreToolUse pour Edit/Write
# Ã‰crit les donnÃ©es dans un fichier JSON pour le plugin VSCode autoclaude

input=$(cat)
tool_name=$(echo "$input" | jq -r '.tool_name // empty')
file_path=$(echo "$input" | jq -r '.tool_input.file_path // empty')

# Ne s'applique qu'aux outils Edit et Write
if [[ "$tool_name" != "Edit" && "$tool_name" != "Write" ]]; then
  exit 0
fi

# Ignorer les fichiers non-code
if [[ "$file_path" != *".ts" && "$file_path" != *".tsx" && "$file_path" != *".py" && "$file_path" != *".js" && "$file_path" != *".jsx" ]]; then
  exit 0
fi

# DÃ©terminer le type de fichier et le message Ã  injecter
file_type="other"
inject_message="pre-edit : "

if [[ "$file_path" == *".py" ]]; then
  file_type="backend"
  inject_message+="ðŸ“— LINT BACKEND (Ruff + MyPy):
| RÃ¨gle | Limite |
| line-length | 100 chars |
| max-args (PLR0913) | 6 params |
| max-statements | 50/fonction |
| T20 (print) | interdit |
| mypy strict | tous les types requis |
âœ“ cd backend && ruff check . && mypy ."
fi

if [[ "$file_path" == *".ts" || "$file_path" == *".tsx" || "$file_path" == *".js" || "$file_path" == *".jsx" ]]; then
  file_type="frontend"
  inject_message+="ðŸ“˜ LINT FRONTEND (ESLint):
| RÃ¨gle | Limite |
| max-lines | 300 lignes/fichier |
| max-lines-per-function | 80 lignes |
| max-params | 5 params |
| max-depth | 4 niveaux |
| curly | toujours {} |
| no-console | sauf warn/error |
| explicit-function-return-type | requis |
âœ“ npm --prefix frontend run lint && typecheck"
fi

# Obtenir le rÃ©pertoire du script (hooks/)
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
CLAUDE_DIR="$(dirname "$SCRIPT_DIR")"

# Ã‰crire les donnÃ©es JSON pour le plugin VSCode
cat > "$CLAUDE_DIR/pre-edit-data.json" <<EOF
{
  "hookType": "pre-edit",
  "toolName": "$tool_name",
  "filePath": "$file_path",
  "fileType": "$file_type",
  "timestamp": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")",
  "injectMessage": $(echo "$inject_message" | jq -Rs .)
}
EOF

# Debug log
echo "[$(date)] pre-edit: $file_path ($file_type)" >> /tmp/claude-hooks.log

exit 0
